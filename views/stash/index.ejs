<%- include('../partials/header') %>

<div class="container stash-planner">
  <div class="stash-header">
    <div>
      <h1>STASH PLANNER</h1>
      <p class="help-text">Plan your inventory for maximum efficiency</p>
    </div>
    <div class="slot-count">
      <strong id="total-slots"><%= totalSlots || 0 %></strong> slots used
    </div>
  </div>

  <div class="stash-layout">
    <!-- Category Tabs Sidebar -->
    <div class="category-tabs">
      <button class="category-tab active" data-category="craftable" title="All Craftable">
        <img src="/icons/categories/all.svg" alt="All">
      </button>
      <button class="category-tab" data-category="augment" title="Augments">
        <img src="/icons/categories/augment.svg" alt="Augments">
      </button>
      <button class="category-tab" data-category="shield" title="Shields">
        <img src="/icons/categories/shield.svg" alt="Shields">
      </button>
      <button class="category-tab" data-category="weapon" title="Weapons">
        <img src="/icons/categories/weapon.svg" alt="Weapons">
      </button>
      <button class="category-tab" data-category="ammunition" title="Ammunition">
        <img src="/icons/categories/ammunition.svg" alt="Ammunition">
      </button>
      <button class="category-tab" data-category="modification" title="Modifications">
        <img src="/icons/categories/modification.svg" alt="Modifications">
      </button>
      <button class="category-tab" data-category="quick-use" title="Quick Use">
        <img src="/icons/categories/quick-use.svg" alt="Quick Use">
      </button>
      <button class="category-tab" data-category="key" title="Keys">
        <img src="/icons/categories/key.svg" alt="Keys">
      </button>
      <button class="category-tab" data-category="material" title="Materials">
        <img src="/icons/categories/material.svg" alt="Materials">
      </button>
      <button class="category-tab" data-category="misc" title="Misc & Trinkets">
        <img src="/icons/categories/misc.svg" alt="Misc">
      </button>
    </div>

    <!-- Main Content -->
    <div class="stash-content">
      <!-- Desired Items Section -->
      <div class="stash-section desired-section">
        <div class="stash-section-header">
          <h2>Desired Inventory</h2>
        </div>
        <div class="item-grid" id="desired-grid">
          <% if (selectedItems && selectedItems.length > 0) { %>
            <% selectedItems.forEach(s => { %>
              <% if (s.item) { %>
                <div class="item-cell rarity-<%= s.item.rarity ? s.item.rarity.toLowerCase() : 'common' %>"
                     data-item-id="<%= s.item.id %>"
                     data-stacks="<%= s.stacks %>"
                     data-category="<%= s.item.category_id %>"
                     data-name="<%= s.item.name %>"
                     onclick="goToItem(<%= s.item.id %>)"
                     style="cursor: pointer;">
                  <div class="quantity-controls">
                    <button class="btn-minus" onclick="adjustQuantity(<%= s.item.id %>, -1)">-</button>
                    <button class="btn-plus" onclick="adjustQuantity(<%= s.item.id %>, 1)">+</button>
                  </div>
                  <button class="btn-remove" onclick="removeItem(<%= s.item.id %>)">&times;</button>
                  <% if (s.item.image_path) { %>
                    <img src="<%= s.item.image_path %>" alt="<%= s.item.name %>">
                  <% } else { %>
                    <div style="display:flex;align-items:center;justify-content:center;height:100%;color:#6b7280;font-size:0.7rem;text-align:center;padding:8px;"><%= s.item.name %></div>
                  <% } %>
                  <span class="quantity-badge">x<%= s.stacks %></span>
                </div>
              <% } %>
            <% }) %>
          <% } %>
          <!-- Add Item Cell -->
          <div class="add-item-cell" onclick="openItemModal()">
            <span class="plus-icon">+</span>
          </div>
        </div>
      </div>

      <div class="stash-divider"></div>

      <!-- Optimal Inventory Section -->
      <div class="stash-section optimal-section">
        <div class="stash-section-header">
          <h2>Optimal Inventory</h2>
        </div>
        <% if (results && results.length > 0) { %>
          <div class="item-grid" id="optimal-grid">
            <% results.forEach(r => { %>
              <div class="item-cell rarity-<%= r.item.rarity ? r.item.rarity.toLowerCase() : 'common' %>"
                   data-category="<%= r.item.category_id %>"
                   data-name="<%= r.item.name %>"
                   data-reason="<%= r.reasons.join(', ') %>"
                   onclick="goToItem(<%= r.item.id %>)"
                   style="cursor: pointer;">
                <% if (r.item.image_path) { %>
                  <img src="<%= r.item.image_path %>" alt="<%= r.item.name %>">
                <% } else { %>
                  <div style="display:flex;align-items:center;justify-content:center;height:100%;color:#6b7280;font-size:0.7rem;text-align:center;padding:8px;"><%= r.item.name %></div>
                <% } %>
                <span class="quantity-badge">x<%= r.stacks %></span>
              </div>
            <% }) %>
          </div>
        <% } else { %>
          <div class="stash-empty">
            <p>Add items above to see the optimal inventory calculation.</p>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<!-- Item Selection Modal -->
<div class="item-modal-overlay" id="item-modal">
  <div class="item-modal">
    <div class="item-modal-header">
      <h3>Select Item</h3>
      <button class="item-modal-close" onclick="closeItemModal()">&times;</button>
    </div>
    <div class="item-modal-search">
      <input type="text" id="modal-search" placeholder="Search items..." oninput="filterModalItems()">
    </div>
    <div class="item-modal-grid">
      <div class="item-grid" id="modal-items-grid">
        <!-- Items will be populated by JavaScript -->
      </div>
    </div>
  </div>
</div>

<!-- Hidden form for saving -->
<form id="stash-form" action="/stash" method="POST" class="stash-form">
  <input type="hidden" name="active_category" id="active-category-input" value="<%= activeCategory || 'craftable' %>">
  <div id="form-inputs"></div>
</form>

<script>
  // All items data from server
  const allItems = <%- JSON.stringify(allItems) %>;

  // Category mapping for tabs (all tabs require is_craftable)
  const categoryMapping = {
    'craftable': null,  // All craftable items
    'augment': [7],
    'shield': [9],
    'weapon': [10],
    'ammunition': [8],
    'modification': [11],
    'quick-use': [5],
    'key': [6],
    'material': [1, 2, 3, 4],
    'misc': [12, 13, 14, 15]  // Trinket, Misc, Recyclable, Nature
  };

  // Current state - restore from server
  let currentCategory = '<%= activeCategory || 'craftable' %>';
  let desiredItems = {};

  // Initialize from server data
  <% if (selectedItems && selectedItems.length > 0) { %>
    <% selectedItems.forEach(s => { %>
      <% if (s.item) { %>
        desiredItems[<%= s.item.id %>] = <%= s.stacks %>;
      <% } %>
    <% }) %>
  <% } %>

  // Tab switching
  document.querySelectorAll('.category-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      currentCategory = tab.dataset.category;
      document.getElementById('active-category-input').value = currentCategory;
      filterGridsByCategory();
    });
  });

  // Restore active tab on page load
  (function initActiveTab() {
    document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
    const activeTab = document.querySelector(`.category-tab[data-category="${currentCategory}"]`);
    if (activeTab) {
      activeTab.classList.add('active');
    }
    filterGridsByCategory();
  })();

  function filterGridsByCategory() {
    const categoryIds = categoryMapping[currentCategory];

    // Filter desired items grid (but never hide the add-item cell)
    document.querySelectorAll('#desired-grid > *').forEach(cell => {
      if (cell.classList.contains('add-item-cell')) {
        cell.style.display = ''; // Always show add button
      } else if (cell.classList.contains('item-cell')) {
        const itemCategory = parseInt(cell.dataset.category);
        if (categoryIds === null || categoryIds.includes(itemCategory)) {
          cell.style.display = '';
        } else {
          cell.style.display = 'none';
        }
      }
    });

    // Filter optimal items grid
    document.querySelectorAll('#optimal-grid .item-cell').forEach(cell => {
      const itemCategory = parseInt(cell.dataset.category);
      if (categoryIds === null || categoryIds.includes(itemCategory)) {
        cell.style.display = '';
      } else {
        cell.style.display = 'none';
      }
    });
  }

  // Item modal functions
  function openItemModal() {
    const modal = document.getElementById('item-modal');
    modal.classList.add('active');
    document.getElementById('modal-search').value = '';
    populateModalItems();
    document.getElementById('modal-search').focus();
  }

  function closeItemModal() {
    document.getElementById('item-modal').classList.remove('active');
  }

  function populateModalItems() {
    const grid = document.getElementById('modal-items-grid');
    const categoryIds = categoryMapping[currentCategory];
    const searchTerm = document.getElementById('modal-search').value.toLowerCase();

    // Filter items: must be craftable, match category, match search, not already added
    let filteredItems = allItems.filter(item => {
      const isCraftable = item.is_craftable;
      const matchesCategory = categoryIds === null || categoryIds.includes(item.category_id);
      const matchesSearch = item.name.toLowerCase().includes(searchTerm);
      const notAlreadyAdded = !desiredItems[item.id];
      return isCraftable && matchesCategory && matchesSearch && notAlreadyAdded;
    });

    grid.innerHTML = filteredItems.map(item => `
      <div class="item-cell rarity-${item.rarity ? item.rarity.toLowerCase() : 'common'}"
           data-name="${item.name}"
           onclick="selectItem(${item.id})">
        ${item.image_path
          ? `<img src="${item.image_path}" alt="${item.name}">`
          : `<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#6b7280;font-size:0.6rem;text-align:center;padding:4px;">${item.name}</div>`
        }
      </div>
    `).join('');
  }

  function filterModalItems() {
    populateModalItems();
  }

  function selectItem(itemId) {
    desiredItems[itemId] = 1;
    closeItemModal();
    saveAndRefresh();
  }

  // Quantity adjustment
  function adjustQuantity(itemId, delta) {
    event.stopPropagation();
    const newQty = (desiredItems[itemId] || 0) + delta;
    if (newQty <= 0) {
      delete desiredItems[itemId];
    } else {
      desiredItems[itemId] = newQty;
    }
    saveAndRefresh();
  }

  // Remove item entirely
  function removeItem(itemId) {
    event.stopPropagation();
    delete desiredItems[itemId];
    saveAndRefresh();
  }

  // Navigate to item details page
  function goToItem(itemId) {
    window.location.href = '/items/' + itemId;
  }

  // Save and refresh
  function saveAndRefresh() {
    const formInputs = document.getElementById('form-inputs');
    formInputs.innerHTML = '';

    Object.entries(desiredItems).forEach(([itemId, stacks]) => {
      const idInput = document.createElement('input');
      idInput.type = 'hidden';
      idInput.name = 'item_ids';
      idInput.value = itemId;
      formInputs.appendChild(idInput);

      const qtyInput = document.createElement('input');
      qtyInput.type = 'hidden';
      qtyInput.name = 'quantities';
      qtyInput.value = stacks;
      formInputs.appendChild(qtyInput);
    });

    document.getElementById('stash-form').submit();
  }

  // Close modal on overlay click
  document.getElementById('item-modal').addEventListener('click', (e) => {
    if (e.target.id === 'item-modal') {
      closeItemModal();
    }
  });

  // Close modal on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeItemModal();
    }
  });

  // Tooltip for optimal inventory items
  const tooltip = document.createElement('div');
  tooltip.className = 'item-tooltip';
  tooltip.style.cssText = `
    position: fixed;
    background: rgba(0, 0, 0, 0.95);
    color: #fff;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.8rem;
    max-width: 280px;
    text-align: center;
    pointer-events: none;
    z-index: 9999;
    opacity: 0;
    transition: opacity 0.15s ease;
    white-space: normal;
  `;
  document.body.appendChild(tooltip);

  function attachTooltip(cell) {
    cell.addEventListener('mouseenter', (e) => {
      const name = cell.dataset.name || '';
      const reason = cell.dataset.reason || '';
      if (name || reason) {
        tooltip.textContent = reason ? `${name} â€” ${reason}` : name;
        tooltip.style.opacity = '1';
      }
    });

    cell.addEventListener('mousemove', (e) => {
      tooltip.style.left = e.clientX + 'px';
      tooltip.style.top = (e.clientY - tooltip.offsetHeight - 10) + 'px';
    });

    cell.addEventListener('mouseleave', () => {
      tooltip.style.opacity = '0';
    });
  }

  // Attach tooltips to both desired and optimal inventory items
  document.querySelectorAll('.desired-section .item-cell').forEach(attachTooltip);
  document.querySelectorAll('.optimal-section .item-cell').forEach(attachTooltip);
</script>

<%- include('../partials/footer') %>
