<%- include('../partials/header') %>

<div class="container">
  <h1>Add New Item</h1>

  <% if (error) { %>
    <div class="error"><%= error %></div>
  <% } %>

  <form action="/items" method="POST">
    <div class="form-group">
      <label for="name">Item Name</label>
      <input type="text" id="name" name="name" required>
    </div>

    <div class="form-group">
      <label for="category">Category</label>
      <select id="category" name="category" required>
        <option value="">Select a category</option>
        <option value="gun">üî´ gun</option>
        <option value="gun mod">üîß gun mod</option>
        <option value="augment">‚ö° augment</option>
        <option value="quick use">üíä quick use</option>
        <option value="crafting material">üß± crafting material</option>
        <option value="ammunition">üéØ ammunition</option>
        <option value="shield">üõ°Ô∏è shield</option>
      </select>
    </div>

    <div class="form-group" id="stack-size-group">
      <label for="stack_size">Stack Size</label>
      <input type="number" id="stack_size" name="stack_size" min="1" value="1" required>
    </div>

    <div class="recipe-section">
      <h3>Crafting Recipe (optional)</h3>
      <p class="help-text">Leave empty if this is a base item that cannot be crafted.</p>

      <div id="materials-container">
        <!-- Material rows will be added here -->
      </div>

      <button type="button" id="add-material" class="btn btn-secondary">+ Add Material</button>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn btn-primary">Create Item</button>
      <a href="/items" class="btn">Cancel</a>
    </div>
  </form>
</div>

<script>
  const craftingMaterials = <%- JSON.stringify(craftingMaterials) %>;
  const container = document.getElementById('materials-container');
  const categorySelect = document.getElementById('category');
  const stackSizeGroup = document.getElementById('stack-size-group');
  const stackSizeInput = document.getElementById('stack_size');

  const fixedStackCategories = ['gun', 'gun mod', 'augment', 'shield'];

  function updateStackSizeVisibility() {
    const category = categorySelect.value;
    if (fixedStackCategories.includes(category)) {
      stackSizeGroup.style.display = 'none';
      stackSizeInput.value = 1;
    } else {
      stackSizeGroup.style.display = 'block';
    }
  }

  categorySelect.addEventListener('change', updateStackSizeVisibility);
  updateStackSizeVisibility();

  function createMaterialRow(materialId, quantity) {
    materialId = materialId || '';
    quantity = quantity || 1;
    const row = document.createElement('div');
    row.className = 'material-row';

    const select = document.createElement('select');
    select.name = 'material_ids';
    select.required = true;
    select.innerHTML = '<option value="">Select material</option>' +
      craftingMaterials.map(m =>
        '<option value="' + m.id + '"' + (m.id == materialId ? ' selected' : '') + '>' + m.name + '</option>'
      ).join('');

    const input = document.createElement('input');
    input.type = 'number';
    input.name = 'quantities';
    input.min = 1;
    input.value = quantity;
    input.required = true;

    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn btn-danger';
    removeBtn.textContent = 'Remove';
    removeBtn.addEventListener('click', function() { row.remove(); });

    row.appendChild(select);
    row.appendChild(input);
    row.appendChild(removeBtn);
    container.appendChild(row);
  }

  document.getElementById('add-material').addEventListener('click', function() {
    createMaterialRow();
  });
</script>

<%- include('../partials/footer') %>
